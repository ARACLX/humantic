version: 2.1

# Required Environment Variables that are used by configuration:
# CODECOV_TOKEN (Project-based)
# CODACY_PROJECT_TOKEN (Project-based)
# NPM_TOKEN (Project-based, can be global)
# SKIP_PREFLIGHT_CHECK (true)... Damn CRA :/
#
# DOCKER_LOGIN
# DOCKER_PASSWORD

orbs:
  node: circleci/node@4.0.0
  docker: circleci/docker@1.4.0
  codecov: codecov/codecov@1.1.1
  codacy: codacy/coverage-reporter@11.2.1

executors:
  node:
    docker:
      - image: cimg/base:2020.01
      - image: circleci/mongo:latest

jobs:
  build:
    working_directory: ~/humantic
    executor: node
    steps:
      - checkout
      - node/install:
          install-yarn: true
          lts: true
      - node/install-yarn
      - run: node --version
      - run: yarn --version
      - node/install-packages:
          app-dir: ~/humantic
          pkg-manager: yarn
      - run: yarn build
      - run: yarn test:unit
      - run: yarn test:cov
      - codecov/upload
      - codacy/send_report
